<html><!-- #BeginTemplate "/Templates/Richieste.dwt" -->
<head>
<script language="JavaScript" src="../funzioni.js"></script>
<script language="JavaScript" src="../scroller.js"></script>
<!-- #BeginEditable "doctitle" --> 
<title>Rilevare se un processo è attivo</title>
<!-- #EndEditable --> 
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link href="../stili.css" rel="stylesheet" type="text/css" title="stili">
<link href="../codicevb.css" rel="stylesheet" type="text/css" title="codicevb">
<link href="../colori.css" rel="stylesheet" type="text/css" title="colori">
<meta name="description" content="Visual Basic Simple &egrave; l'unico sito in Italia che tratta la programmazione in Visual Basic in un'ottica mai vista prima d'ora. Tutti gli articoli sono spiegati passo dopo passo ed in una maniera davvero semplice per consentire a tutti di comprendere gli argomenti trattati.">
<meta name="keywords" content="VB, Visual, Basic, Simple, programmazione, codici, esempi, manuali, studio, sviluppo, ActiveX, OCX, articoli, notizie, apprendere, QBasic, API, COM, database">
</head>

<body bgcolor="#FFFFFF" leftmargin="0" topmargin="0">
<table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#FFFFFF">
  <tr>
    <td width="400" align="left" bgcolor="#FFFFFF"><img src="../images/vbslogo.jpg" width="400" height="80" border="0" alt="Visual Basic Simple"></td>
    <td width="100%" align="right" bgcolor="#FFFFFF"> 
      <div class="intestazioni"><a href="../home.htm">Home Page</a> <a href="../home.htm"><img src="../images/icons/dothome.gif" align="absmiddle" border="0" alt="Home Page" width="25" height="25"></a><br>
        <a href="../history.htm">Novit&agrave;</a> <a href="../history.htm"><img src="../images/icons/dotinfo.gif" align="absmiddle" border="0" alt="Informazioni su VB Simple" width="25" height="25"></a><br>
        <a href="../help.htm">Aiuto</a> <a href="../help.htm"><img src="../images/icons/dothelp.gif" align="absmiddle" border="0" alt="Hai bisogno d'aiuto?" width="25" height="25"></a></div>
    </td>
    <td width="160" align="center"><script type="text/javascript"><!--
google_ad_client = "pub-8218922773694577";
/* 160x90, creato 02/02/09 */
google_ad_slot = "8970907891";
google_ad_width = 160;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></td>
  </tr>
</table>

<div align="center"> 
  <div class="titolo"><!-- #BeginEditable "TITOLO" -->Rilevare se un processo 
    &egrave; attivo<!-- #EndEditable --></div>
  <script language="Javascript">NomePagina();</script>
  <table width="80%" border="1" cellspacing="1" cellpadding="3" bordercolorlight="#000000" bordercolordark="#000000" class="dontprint">
    <tr class="size0"> 
      <td align="center" width="25%"><a href="../ftv21/activity.htm" target="treeframe"><img src="../images/icons/search%20window.gif" width="16" height="16" border="0" alt="Sincronizza Indice"><br>
        Sincronizza Indice</a></td>
      <td align="center" width="25%"><a href="javascript:ScaricaZIP();"><img src="../images/icons/tool%20download.gif" width="16" height="18" border="0" alt="Scarica il progetto"><br>
        Scarica il progetto</a></td>
      <td align="center" width="25%"><a href="javascript:ScaricaPDF();"><img src="../images/icons/tool%20pdf.gif" width="16" height="18" alt="Scarica il testo dell'articolo" border="0"><br>
        Testo dell'articolo</a></td>
      <td align="center" width="25%"><a href="javascript:Stampa();"><img src="../images/icons/tool%20print.gif" width="16" height="18" alt="Stampa l'articolo" border="0"><br>
        Stampa l'articolo</a></td>
    </tr>
  </table>
</div>
<table width="100%" border="0">
  <tr> 
    <td width="80%"> 
      <table width="100%"><tr><td align="left" nowrap><style type="text/css">
@import url(http://www.google.com/cse/api/branding.css);
</style>
<div class="cse-branding-right" style="background-color:#FFFFFF;color:#000000">
  <div class="cse-branding-form">
    <form action="http://www.google.it/cse" id="cse-search-box">
      <div>
        <input type="hidden" name="cx" value="partner-pub-8218922773694577:rv2o52-qh5a" />
        <input type="hidden" name="ie" value="ISO-8859-1" />
        <input type="text" name="q" size="20" />
        <input type="submit" name="sa" value="Cerca" />
      </div>
    </form>
  </div>
  <div class="cse-branding-logo">
    <img src="http://www.google.com/images/poweredby_transparent/poweredby_FFFFFF.gif" alt="Google" />
  </div>
  <div class="cse-branding-text">
    Ricerca personalizzata
  </div>
</div></td><td align="right">
      <p align="right" class="size3">Richiesta di: <!-- #BeginEditable "RICHIEDENTE" -->Nicola 
        Mangiameli<!-- #EndEditable --> 
        - <!-- #BeginEditable "DATARICHIESTA" -->15 
        Ottobre 2003<!-- #EndEditable --><br>
        Difficolt&agrave;: <img src="../images/icons/level1.gif" width="17" height="18" align="absmiddle"><!-- #BeginEditable "DIFFICOLTA" --><img src="../images/icons/level2.gif" width="17" height="18" align="absmiddle"> 
        2<!-- #EndEditable --> / 5 </p>
</td></tr></table>
      <script language="JavaScript">ShowArticlesScroller();</script><!-- #BeginEditable "CORPO" --> 
      <p><i>Vorrei realizzare un programmino che in runtime controlli se è attivo 
        un processo esterno (per intenderci se è in esecuzione un .exe specifico).</i></p>
      <hr>
      <p><img src="../images/activity/att25_01.png" width="270" height="139" align="right" alt="Figura 1">Apparentemente 
        il problema potrebbe sembrare pi&ugrave; complesso di quanto non lo sia 
        realmente ma vedremo come poche righe di codice possono risolvere questa 
        necessit&agrave;. A tal scopo aggiungeremo due semplici controlli sopra 
        un form: una <i>ListBox</i> di nome <b>lbProcessi</b> ed un <i>CommandButton</i> 
        di nome <b>cmdAggiorna</b>.</p>
      <p>Il funzionamento &egrave; semplice quanto banale: il click sopra l'unico 
        pulsante riporter&agrave; tutti i <a href="../glossary/p.htm#PROCESSO">processi</a> 
        in esecuzione all'interno della ListBox, inizialmente vuota.</p>
      <p>Il codice deve necessariamente utilizzare alcune funzioni dell'<a href="../glossary/a.htm#API">API</a> 
        di Windows; in particolare l'operazione si compone di due passi: la fotografia 
        (<i>snapshot</i>) della situazione del sistema attuale ed il recupero 
        di tutti i processi in esecuzione al momento della fotografia.</p>
      <p align="center"><script type="text/javascript"><!--
google_ad_client = "pub-8218922773694577";
/* 468x60 solo grafica */
google_ad_slot = "0981518759";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></p>
      <p>Iniziamo a vedere le definizioni API:</p>
      <ol start="1" class="codicevb">
        <li>Option Explicit</li>
        <li></li>
        <li>Private Const TH32CS_SNAPPROCESS = &amp;H2</li>
        <li>Private Const MAX_PATH As Integer = 260</li>
        <li></li>
        <li>Private Type PROCESSENTRY32</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;dwSize As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;cntUsage As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;th32ProcessID As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;th32DefaultHeapID As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;th32ModuleID As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;cntThreads As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;th32ParentProcessID As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;pcPriClassBase As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;dwFlags As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;szExeFile As String * MAX_PATH</li>
        <li>End Type</li>
        <li></li>
        <li>Private Declare Function CreateToolhelp32Snapshot Lib &quot;Kernel32&quot; 
          (ByVal lFlags As Long, ByVal lProcessID As Long) As Long</li>
        <li>Private Declare Function Process32First Lib &quot;Kernel32&quot; (ByVal 
          hSnapShot As Long, uProcess As PROCESSENTRY32) As Long</li>
        <li>Private Declare Function Process32Next Lib &quot;Kernel32&quot; (ByVal 
          hSnapShot As Long, uProcess As PROCESSENTRY32) As Long</li>
        <li>Private Declare Sub CloseHandle Lib &quot;Kernel32&quot; (ByVal hObject 
          As Long)</li>
        <li></li>
      </ol>
      <p>La costante <img src="../images/ide/costante.gif" width="16" height="16" align="absmiddle"> 
        <i><b>TH32CS_SNAPPROCESS</b></i> verr&agrave; utilizzata dalla funzione 
        <i>CreateToolhelp32Snapshot</i> definita pi&ugrave; gi&ugrave; per scattare 
        la fotografia e congelare la situazione; questa costante indica alla funzione 
        di memorizzare soltanto i processi in esecuzione (piuttosto che i <a href="../glossary/t.htm#THREAD">threads</a>, 
        i moduli, etc...). La costante <i><b>MAX_PATH</b></i> definisce invece 
        la lunghezza massima del percorso di ciascun file eseguibile. Vedremo 
        in seguito a cosa serve.</p>
      <p>Alle righe 6-17 &egrave; definito un nuovo tipo di dati <img src="../images/ide/tipoudt.gif" width="16" height="16" align="absmiddle"> 
        di nome <b>PROCESSENTRY32</b>; si tratta di una struttura necessaria per 
        poter recuperare le informazioni sui singoli processi; fondamentalmente 
        per il nostro scopo &egrave; necessario soltanto il campo <b><i>szExeFile</i></b> 
        che andr&agrave; a ricevere il nome del file eseguibile di ogni processo 
        rilevato.</p>
      <p align="center"><script type="text/javascript"><!--
google_ad_client = "pub-8218922773694577";
/* 468x60 solo testo */
google_ad_slot = "6726967947";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></p>
      <p>Alla riga 19 &egrave; definita la funzione API <i>CreateToolhelp32Snapshot</i> 
        che si occuper&agrave; di creare uno snapshot del sistema con il tipo 
        di informazioni specificate nell'argomento <b>lFlags</b>. Le due funzioni 
        successive <i>Process32First</i> e <i>Process32Next</i> consentono di 
        recuperare rispettivamente il primo ed il successivo processo da uno snapshot. 
        I dati recuperati saranno memorizzati nella struttura <b>PROCESSENTRY32</b>. 
        Infine alla riga 19 la funzione <i>CloseHandle</i> consente di chiudere 
        l'<a href="../glossary/h.htm#HANDLE">handle</a> allo snapshot creato.</p>
      <p>Tutto il codice del programma &egrave; concentrato nell'evento Click 
        dell'unico pulsante presente sul form:</p>
      <ol start="24" class="codicevb">
        <li>Private Sub cmdAggiorna_Click()</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;Dim hSnapShot As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;Dim uProcess As PROCESSENTRY32</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;Dim lngRet As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;hSnapShot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 
          0&amp;)</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;uProcess.dwSize = Len(uProcess)</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;lngRet = Process32First(hSnapShot, uProcess)</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;lbProcessi.Clear</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;Do While lngRet</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lbProcessi.AddItem 
          Left$(uProcess.szExeFile, InStr(1, uProcess.szExeFile, vbNullChar) - 
          1)</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lngRet = Process32Next(hSnapShot, 
          uProcess)</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;Loop</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle hSnapShot</li>
        <li>End Sub</li>
      </ol>
      <p>La variabile <b>hSnapShot</b> ricever&agrave; l'handle dello snapshot 
        creato; <b>uProcess</b> ricever&agrave; invece i dati sul singolo processo 
        rilevato ed infine <b>lngRet</b> sar&agrave; utilizzata per verificare 
        la disponibilit&agrave; di ulteriori processi nello snapshot.<br>
        La prima operazione che verr&agrave; eseguita &egrave; naturalmente la 
        creazione della fotografia (riga 28); come gi&agrave; detto l'handle recuperato 
        rester&agrave; in <b>hSnapShot</b>. La costante specificata nella chiamata 
        della funzione indicher&agrave; alla stessa di recuperare soltanto le 
        informazioni sui processi in esecuzione.</p>
      <p>Alla riga 29 &egrave; definita l'ampiezza della struttura <b>uProcess</b> 
        e quindi sar&agrave; recuperato il primo processo dallo snapshot mediante 
        <i>Process32First</i>. Il valore di ritorno di questa funzione se differente 
        da zero indicher&agrave; il corretto recupero del processo dallo snapshot. 
        Pertanto, una volta azzerato l'elenco <b>lbProcessi</b> sar&agrave; possibile 
        avviare un ciclo che recuperi ogni processo. Alla riga 33 sar&agrave; 
        inserito nell'elenco il nome del file eseguibile del processo rilevato; 
        tale nome &egrave; naturalmente recuperato dal campo <i><b>szExeFile</b></i> 
        della struttura. Poich&eacute; trattasi di una stringa terminata con un 
        <a href="../glossary/n.htm#NULL">null</a> (<b>sz</b> indica appunto una 
        stringa terminata con un carattere 0) sar&agrave; opportuno eliminare 
        i caratteri in eccedenza.</p>
    <p align="center"><script type="text/javascript"><!--
google_ad_client = "pub-8218922773694577";
/* Contenuti 468x60 */
google_ad_slot = "0785185013";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></p>
      <p><img src="../images/activity/att25_02.png" width="270" height="139" align="right" alt="Figura 2">Questo 
        giro &egrave; ripetuto per ogni processo recuperato (la prima volta con 
        <i>Process32First</i> e le successive con <i>Process32Next</i>). Al termine 
        dell'operazione potremo chiudere l'handle allo snapshot creato e librerare 
        quindi l'area in memoria.</p>
      <p>Il risultato naturalmente riporter&agrave; il nome di tutti i processi 
        in esecuzione, in maniera analoga al Task Manager di Windows NT/2000/XP. 
        Da qui a capire se un determinato processo &egrave; in esecuzione il salto 
        &egrave; breve; un semplice controllo su ciascun processo recuperato potr&agrave; 
        rivelarci questa informazione.<br>
        <br>
      </p>
      <!-- #EndEditable --></td>
  </tr>
</table>

<table width="100%">
  <tr> 
    <td><!-- #BeginEditable "FINALE" --> 
      <p>Il codice non presenta alcun rischio particolare n&eacute; difficolt&agrave; 
        alcuna; la creazione dello snapshot congeler&agrave; la situazione dei 
        processi al momento della fotografia e le successive interrogazioni saranno 
        fatte su questa fotografia. &Egrave; naturalmente opportuno creare uno 
        snapshot ogni volta che si desidera analizzare le informazioni sui processi 
        e non utilizzare la vecchia fotografia; i dati infatti dentro lo snapshot 
        non saranno mai aggiornati e riporteranno sempre la medesima situazione.</p>
      <!-- #EndEditable --><!-- #BeginEditable "CREDITS" --> 
      <p align="right" class="credits2"><a href="../vbmail.htm?id=1">Fibia 
        FBI</a><br>
        2 Novembre 2003</p>
      <!-- #EndEditable --><!-- #BeginLibraryItem "/Library/Toolbar.lbi" -->
      <table width="80%" border="1" cellspacing="1" cellpadding="3" align="center" bordercolor="#000000" class="dontprint">
        <tr> 
          <td align="center" valign="top" width="33%"><a href="javascript:ScaricaZIP();"><img src="../images/icons/tool%20download.gif" width="16" height="18" border="0" alt="Scarica il progetto"><br>
            <span class="size1">Scarica il progetto</span></a></td>
          <td align="center" valign="top" width="33%"><a href="javascript:ScaricaPDF();"><img src="../images/icons/tool%20pdf.gif" width="16" height="18" alt="Scarica il testo dell'articolo" border="0"><br>
            <span class="size1">Scarica il testo dell'articolo</span></a></td>
          <td align="center" valign="top" width="33%"><a href="javascript:Stampa();"><img src="../images/icons/tool%20print.gif" width="16" height="18" alt="Stampa l'articolo" border="0"><br>
            <span class="size1">Stampa l'articolo</span></a></td>
        </tr>
      </table><!-- #EndLibraryItem -->
    </td>
  </tr>
</table>
<table width="100%" border="0" cellspacing="2" cellpadding="2">
  <tr>
    <td align="left"><a href="index.htm"><img src="../images/vbprev.jpg" width="49" height="32" align="absmiddle" border="0"> 
      Torna all'introduzione delle Richieste dei lettori</a></td>
    <td align="right">&nbsp;</td>
  </tr>
</table>

<hr width="80%">
<table width="100%">
  <tr>
    <td width="100%" align="center">
      <script language="Javascript">Banner();</script>
      <!--#echo banner=""-->
    </td>
  </tr>
</table>
<script language="Javascript">FibiaWebStats();</script>
</body>
<!-- #EndTemplate --></html>
