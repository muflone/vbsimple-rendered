<html><!-- #BeginTemplate "/Templates/Richieste.dwt" -->
<head>
<script language="JavaScript" src="../funzioni.js"></script>
<script language="JavaScript" src="../scroller.js"></script>
<!-- #BeginEditable "doctitle" --> 
<title>Calcolo del CRC32 di un testo</title>
<!-- #EndEditable --> 
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link href="../stili.css" rel="stylesheet" type="text/css" title="stili">
<link href="../codicevb.css" rel="stylesheet" type="text/css" title="codicevb">
<link href="../colori.css" rel="stylesheet" type="text/css" title="colori">
<meta name="description" content="Visual Basic Simple &egrave; l'unico sito in Italia che tratta la programmazione in Visual Basic in un'ottica mai vista prima d'ora. Tutti gli articoli sono spiegati passo dopo passo ed in una maniera davvero semplice per consentire a tutti di comprendere gli argomenti trattati.">
<meta name="keywords" content="VB, Visual, Basic, Simple, programmazione, codici, esempi, manuali, studio, sviluppo, ActiveX, OCX, articoli, notizie, apprendere, QBasic, API, COM, database">
</head>

<body bgcolor="#FFFFFF" leftmargin="0" topmargin="0">
<table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#FFFFFF">
  <tr>
    <td width="400" align="left" bgcolor="#FFFFFF"><img src="../images/vbslogo.jpg" width="400" height="80" border="0" alt="Visual Basic Simple"></td>
    <td width="100%" align="right" bgcolor="#FFFFFF"> 
      <div class="intestazioni"><a href="../home.htm">Home Page</a> <a href="../home.htm"><img src="../images/icons/dothome.gif" align="absmiddle" border="0" alt="Home Page" width="25" height="25"></a><br>
        <a href="../history.htm">Novit&agrave;</a> <a href="../history.htm"><img src="../images/icons/dotinfo.gif" align="absmiddle" border="0" alt="Informazioni su VB Simple" width="25" height="25"></a><br>
        <a href="../help.htm">Aiuto</a> <a href="../help.htm"><img src="../images/icons/dothelp.gif" align="absmiddle" border="0" alt="Hai bisogno d'aiuto?" width="25" height="25"></a></div>
    </td>
    <td width="160" align="center"><script type="text/javascript"><!--
google_ad_client = "pub-8218922773694577";
/* 160x90, creato 02/02/09 */
google_ad_slot = "8970907891";
google_ad_width = 160;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></td>
  </tr>
</table>

<div align="center"> 
  <div class="titolo"><!-- #BeginEditable "TITOLO" -->Calcolo del CRC32 di un 
    testo<!-- #EndEditable --></div>
  <script language="Javascript">NomePagina();</script>
  <table width="80%" border="1" cellspacing="1" cellpadding="3" bordercolorlight="#000000" bordercolordark="#000000" class="dontprint">
    <tr class="size0"> 
      <td align="center" width="25%"><a href="../ftv21/activity.htm" target="treeframe"><img src="../images/icons/search%20window.gif" width="16" height="16" border="0" alt="Sincronizza Indice"><br>
        Sincronizza Indice</a></td>
      <td align="center" width="25%"><a href="javascript:ScaricaZIP();"><img src="../images/icons/tool%20download.gif" width="16" height="18" border="0" alt="Scarica il progetto"><br>
        Scarica il progetto</a></td>
      <td align="center" width="25%"><a href="javascript:ScaricaPDF();"><img src="../images/icons/tool%20pdf.gif" width="16" height="18" alt="Scarica il testo dell'articolo" border="0"><br>
        Testo dell'articolo</a></td>
      <td align="center" width="25%"><a href="javascript:Stampa();"><img src="../images/icons/tool%20print.gif" width="16" height="18" alt="Stampa l'articolo" border="0"><br>
        Stampa l'articolo</a></td>
    </tr>
  </table>
</div>
<table width="100%" border="0">
  <tr> 
    <td width="80%"> 
      <table width="100%"><tr><td align="left" nowrap><style type="text/css">
@import url(http://www.google.com/cse/api/branding.css);
</style>
<div class="cse-branding-right" style="background-color:#FFFFFF;color:#000000">
  <div class="cse-branding-form">
    <form action="http://www.google.it/cse" id="cse-search-box">
      <div>
        <input type="hidden" name="cx" value="partner-pub-8218922773694577:rv2o52-qh5a" />
        <input type="hidden" name="ie" value="ISO-8859-1" />
        <input type="text" name="q" size="20" />
        <input type="submit" name="sa" value="Cerca" />
      </div>
    </form>
  </div>
  <div class="cse-branding-logo">
    <img src="http://www.google.com/images/poweredby_transparent/poweredby_FFFFFF.gif" alt="Google" />
  </div>
  <div class="cse-branding-text">
    Ricerca personalizzata
  </div>
</div></td><td align="right">
      <p align="right" class="size3">Richiesta di: <!-- #BeginEditable "RICHIEDENTE" -->Claudio 
        Gucchierato<!-- #EndEditable --> 
        - <!-- #BeginEditable "DATARICHIESTA" -->23 
        Settembre 2001<!-- #EndEditable --><br>
        Difficolt&agrave;: <img src="../images/icons/level1.gif" width="17" height="18" align="absmiddle"><!-- #BeginEditable "DIFFICOLTA" --><img src="../images/icons/level2.gif" width="17" height="18" align="absmiddle"><img src="../images/icons/level3.gif" width="17" height="18" align="absmiddle"><img src="../images/icons/level4.gif" width="17" height="18" align="absmiddle"> 
        4<!-- #EndEditable --> / 5 </p>
</td></tr></table>
      <script language="JavaScript">ShowArticlesScroller();</script><!-- #BeginEditable "CORPO" -->
      <p><i>Avrei la necessit&agrave; (e la curiosit&agrave;) di sapere come si 
        pu&ograve; calcolare il CRC di un file. Immaginando che la cosa possa 
        interessare anche altre persone (in rete non si trovano esempi documentati 
        in italiano) vi suggerirei, se lo ritenete possibile, di dedicare un nuovo 
        argomento nella sezione Richieste dei lettori.</i></p>
      <hr>
      <p>Detto, fatto! La richiesta &egrave; alquanto interessante sia come problema 
        pratico (calcolare il CRC32 di un file) sia come argomento didattico (elaborazione 
        di dati binari).</p>
      <p>Il <b>CRC</b>, <i>Cyclic (o Circular) Redundancy Check</i> ovvero <b>Controllo 
        a ridondanza ciclica</b>, &egrave; un algoritmo di calcolo utilizzato 
        per verificare la correttezza dei dati durante la trasmissione o la rilettura 
        degli stessi; tali algoritmi sono due: il <i>CRC16</i> che utilizza un 
        valore a 16 bit, quindi una precisione di 2^16, ed il <i>CRC32</i> che 
        utilizza un valore a 32 bit, quindi una precisione di 2^32.</p>
      <p></p>
      <p> L'algoritmo del CRC si basa sull'analisi dei singoli caratteri del testo 
        da analizzare. Ognuno di questi viene analizzato bit per bit fino alla 
        generazione di un codice di hash rappresentativo del testo analizzato. 
        Il risultato del CRC32 &egrave; infatti un numero a 32 bit compreso tra 
        0 e oltre 2 miliardi.</p>
      <p align="center"><script type="text/javascript"><!--
google_ad_client = "pub-8218922773694577";
/* 468x60 solo grafica */
google_ad_slot = "0981518759";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></p>
      <p>L'utilizzo di Visual Basic per calcoli binari di questo genere non &egrave; 
        proprio ottimale e la scelta di un altro linguaggio quale il C produrrebbe 
        sicuramente risultati migliori. Tralasceremo, pertanto, la pura efficienza 
        del codice e ci concentreremo sullo studio dell'applicazione dell'algoritmo. 
        Si raccomanda la consultazione delle <a href="../info/info_03.htm">informazioni 
        aggiuntive sui sistemi di numerazione</a> e <a href="../info/info_06.htm">sull'algebra 
        booleana</a>. Questo articolo tratter&agrave; l'algoritmo a 32 bit e si 
        snoda lungo quattro sezioni:</p>
      <ol>
        <li>Calcolare la tabella utilizzata per il calcolo del CRC32;</li>
        <li>Calcolare il CRC32 di un testo;</li>
        <li>Come applicare il CRC32;</li>
        <li>Ulteriori applicazioni del CRC32.</li>
      </ol>
      <p>Per comodit&agrave; abbiamo inserito il codice per il calcolo del CRC32 
        all'interno di un modulo <img src="../images/ide/modulo.gif" width="16" height="16" align="absmiddle"> 
        standard e lasciato nel form soltanto il codice per la lettura del file. 
      </p>
      <hr>
      <p align="center" class="size3">Calcolare la tabella utilizzata per il calcolo 
        del CRC32</p>
      <p>Il primo passo verso il calcolo del CRC32 consiste nel generare una tabella 
        di 256 elementi, ognuno dei quali contenente un valore a 32 bit. Esiste 
        una particolare procedura per generare questi valori, alquanto complessa 
        da spiegare. Vedremo subito il codice che ci chiarir&agrave; le idee:</p>
      <ol class="codicevb" start="1">
        <li>Option Explicit</li>
        <li></li>
        <li>Private blnTabellaCalcolata As Boolean</li>
        <li>Private lngTabellaCRC(255) As Long</li>
        <li></li>
        <li>Private Const lngSemeCRC As Long = &amp;HEDB88320</li>
        <li>Private Const lngDefaultCRC As Long = &amp;HFFFFFFFF</li>
        <li></li>
      </ol>
      <p>Poich&eacute; l'elaborazione della tabella del CRC32 pu&ograve; richiedere 
        un certo tempo utilizzeremo una variabile di tipo <i>Boolean</i> (riga 
        3) che informi la funzione che effettua il calcolo del CRC32 che la tabella 
        &egrave; gi&agrave; stata calcolata e pertanto non ha bisogno di essere 
        elaborata nuovamente.<br>
        Alla riga 4 &egrave; dichiarata una <a href="../glossary/m.htm#MATRICE">matrice</a> 
        di 256 elementi ognuno dei quali &egrave; un <a href="../info/info_04.htm">numero 
        Long ovvero un intero a 32 bit</a>.<br>
        Alle righe 6 e 7 sono dichiarate due costanti <img src="../images/ide/costante.gif" width="16" height="16" align="absmiddle"> 
        utilizzate pi&ugrave; avanti come valori di default.</p>
      <ol class="codicevb" start="9">
        <li>Private Sub InizializzaTabella()</li>
        <li>&nbsp;&nbsp;Dim intBytes As Integer</li>
        <li>&nbsp;&nbsp;Dim intConta As Integer</li>
        <li>&nbsp;&nbsp;Dim lngTmpCRC As Long</li>
        <li>&nbsp;&nbsp;Dim lngValoreCRC As Long</li>
        <li></li>
      </ol>
      <p>La funzione di calcolo della tabella &egrave; chiamata <i>InizializzaTabella</i> 
        ed &egrave; <a href="../info/info_05.htm">dichiarata Private</a> per renderla 
        inaccessibile alle altre parti del codice. Sar&agrave; la funzione che 
        calcola il CRC ad eseguirla in base al valore della variabile <b>blnTabellaCalcolata</b>.</p>
      <p>Tralasciando per il momento le altre variabili, quella di nome <b>lngValoreCRC</b> 
        conterr&agrave; il valore che assumer&agrave; ogni elemento della tabella.</p>
      <ol class="codicevb" start="15">
        <li>&nbsp;&nbsp;For intBytes = 0 To 255</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;lngValoreCRC = intBytes</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;For intConta = 0 To 7</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lngTmpCRC = (lngValoreCRC And 
          &amp;HFFFFFFFE) \ 2 And &amp;H7FFFFFFF</li>
      </ol>
      <p>Sar&agrave; eseguito un calcolo per ogni elemento della matrice (quindi 
        256 volte). Il valore iniziale di <b>lngValoreCRC</b> corrisponder&agrave; 
        all'indice di ogni elemento della tabella (riga 16).</p>
      <p>Segue un ciclo che verr&agrave; ripetuto 8 volte. Nessuna attenzione 
        al valore della variabile <b>intConta</b>: essa non sar&agrave; utilizzata 
        in nessuna parte del codice.</p>
      <p>Merita invece una particolare attenzione la riga successiva (riga 18): 
        essa indica l'esecuzione di uno shift a destra di 1 bit senza segno, detto 
        anche <i>ShiftRight</i>. Per una spiegazione sul concetto del BitShifting 
        si rimanda alla sezione <a href="../news/news_07.htm">Articoli - News</a>.<br>
        In particolare essa svolge le seguenti operazioni:</p>
      <ul type="disc">
        <li>Imposta il primo bit del numero lngValoreCRC a 0<br>
          &nbsp;&nbsp;&nbsp;&nbsp;(lngValoreCRC And &amp;HFFFFFFFE) </li>
        <li>Divide il numero ottenuto per 2 (2^1 bit)</li>
        <li>Imposta l'ultimo bit di tale risultato a 0<br>
          &nbsp;&nbsp;&nbsp;&nbsp;And &amp;H7FFFFFFF </li>
        <li>Assegna il risultato dell'espressione alla variabile <b>lngTmpCRC</b></li>
      </ul>
      <ol class="codicevb" start="19">
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If lngValoreCRC And &amp;H1 Then</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lngValoreCRC = lngTmpCRC 
          Xor lngSemeCRC </li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Else</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lngValoreCRC = lngTmpCRC</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End If</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;Next intConta</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;lngTabellaCRC(intBytes) = lngValoreCRC</li>
        <li>&nbsp;&nbsp;Next intBytes</li>
        <li>&nbsp;&nbsp;blnTabellaCalcolata = True</li>
        <li>End Sub</li>
        <li></li>
      </ol>
      <p>Alla riga 19 viene verificato se il primo bit (quello all'estrema destra) 
        del numero <b>lngValoreCRC</b> - che inizialmente viene posto uguale al 
        valore indicato da <b>intBytes</b> - &egrave; impostato su 1.</p>
      <p align="center"><script type="text/javascript"><!--
google_ad_client = "pub-8218922773694577";
/* 468x60 solo testo */
google_ad_slot = "6726967947";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></p>
      <p>Nel caso esso lo sia, il valore del numero <b>lngTmpCRC</b> ottenuto 
        alla riga 18 viene mischiato mediante l'<a href="../info/info_06.htm">operatore 
        XOR</a> con il valore seme (<i>salt</i>) standard indicato dalla costante 
        <img src="../images/ide/costante.gif" width="16" height="16" align="absmiddle"> 
        <b><i>lngSemeCRC</i></b>. </p>
      <p>L'algoritmo standard del CRC32 prevede l'uso del valore di seme 3.988.292.384 
        corrispondente al valore esadecimale EDB8 8320. Tutti gli algoritmi di 
        calcolo del CRC32 utilizzano tale valore e per questa ragione producono 
        sempre lo risultato analizzando il medesimo file. In un'implementazione 
        propria del CRC32 &egrave; possibile utilizzare un valore di seme differente 
        per generare quindi un valore di CRC32 differente.<br>
        In situazioni normali viene utilizzato il valore indicato dalla costante 
        <i> <b>lngSemeCRC</b></i>. </p>
      <p>Tornando all'analisi del codice, se invece il primo bit &egrave; uguale 
        a 0 il valore del numero <b>lngTmpCRC</b> non viene mischiato con alcun 
        numero. In entrambi i casi il valore risultante viene asseganto alla variabile 
        <b>lngValoreCRC</b>.</p>
      <p>Fatto questo il ciclo procede fino all'esecuzione di 8 volte. Quel valore 
        <b>lngValoreCRC</b> che alla riga 16 conteneva l'indice della matrice, 
        dopo la prima esecuzione conterr&agrave; un numero differente, risultante 
        dall'operazione di RightShift di 1 bit e l'eventuale mix con il valore 
        seme eseguita per 8 volte consecutive prima di essere assegnato come valore 
        della matrice <b>lngTabellaCRC</b> alla riga 25.</p>
      <p>Terminata l'elaborazione di tutti i valori della tabella, dopo 256 iterazioni, 
        il valore della variabile <b>blnTabellaCalcolata</b> viene impostato su 
        <i><b>True</b></i> per impedire una successiva rielaborazione che richiederebbe 
        ulteriore tempo. La tabella verr&agrave; infatti elaborata soltanto una 
        volta.</p>
      <hr>
      <p align="center" class="size3">Calcolare il CRC32 di un testo</p>
      <p>Il procedimento per il calcolo del CRC32 vero e proprio &egrave; relativamente 
        semplice e si riassume in un un'unico calcolo rappresentabile in linguaggio 
        C come:</p>
      <p align="center"><code>CRC = (CRC &gt;&gt; 8) XOR CRCTABLE[INPUT XOR (CRC 
        AND FFh)]</code></p>
      <p>Il calcolo rappresenta 3 operazioni:</p>
      <ul>
        <li>RightShift del CRC precedente di 8 bit;</li>
        <li>Mix mediante operatore XOR tra il codice <a href="../glossary/a.htm#ASCII">ASCII</a> 
          del carattere in esame e la parte bassa (compresa tra 0 e 255) del CRC 
          precedente;</li>
        <li>Mix tramite operatore XOR del primo valore trovato con il valore contenuto 
          nella tabella all'indice indicato dal secondo valore trovato.</li>
      </ul>
      <p>Beh... forse non &egrave; poi cos&igrave; semplice come sembrava. <img 
        src="../images/icons/smile%20wink.gif" width="15" height="15" border="0" align="absmiddle"><br>
        Vediamo allora passo dopo passo di cosa si tratta.</p>
      <ol class="codicevb" start="30">
        <li>Public Function CalcolaCRC(ByVal Buffer As String, Optional ByVal 
          CRCPrecedente As Long = lngDefaultCRC, Optional UltimoCRC As Boolean 
          = False) As Long</li>
        <li>&nbsp;&nbsp;Dim Carattere As Byte</li>
        <li>&nbsp;&nbsp;Dim Conta As Integer</li>
        <li>&nbsp;&nbsp;Dim Temp As Long</li>
        <li>&nbsp;&nbsp;Dim IndiceTabellaCRC As Long</li>
        <li></li>
      </ol>
      <p>La funzione che calcola il CRC prende il nome di (ovvio) <i>CalcolaCRC</i> 
        e richiede un parametro obbligatorio corrispondente alla stringa di cui 
        calcolare il CRC. &Egrave; possibile passare altri due parametri opzionali: 
        <b>CRCPrecedente</b> indica il valore di CRC ottenuto in precedenti elaborazioni, 
        utile per effettuare elaborazioni parziali di testi di grosse dimensioni; 
        se esso non viene fornito viene assunto il valore di default indicato 
        dalla costante <i><b>lngDefaultCRC</b></i>. L'altro parametro opzionale 
        &egrave; un valore booleano di nome <b>UltimoCRC</b> che indica se il 
        calcolo del codice CRC &egrave; terminato e pertanto pu&ograve; essere 
        applicata l'ultima trasformazione; il valore predefinito &egrave; <i><b>False</b></i>.</p>
      <p>All'interno della funzione sono dichiarate 4 variabili: la prima, di 
        nome <b>Carattere</b>, identifica il codice <a href="../glossary/a.htm#ASCII">ASCII</a> 
        del carattere in esame nella stringa da elaborare; la seconda, di nome 
        Conta, verr&agrave; utilizzata soltanto per effettuare un ciclo su tutti 
        i caratteri della stringa da elaborare; le ultime due variabili: <b>Temp</b> 
        ed <b>IndiceTabellaCRC</b> rappresentano i primi due passaggi descritti 
        nella spiegazione del precedente codice in linguaggio C, ovvero il RightShift 
        di 8 bit ed il mix mediante operatore XOR, operazioni che saranno descritte 
        pi&ugrave; avanti.</p>
      <ol class="codicevb" start="36">
        <li>&nbsp;&nbsp;If blnTabellaCalcolata = False Then InizializzaTabella</li>
        <li>&nbsp;&nbsp;CalcolaCRC = CRCPrecedente</li>
        <li>&nbsp;&nbsp;For Conta = 1 To Len(Buffer)</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;Carattere = Asc(Mid$(Buffer, Conta, 1))</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;Temp = (CalcolaCRC And &amp;HFFFFFF00) \ &amp;H100 
          And &amp;HFFFFFF</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;IndiceTabellaCRC = Carattere Xor (CalcolaCRC 
          And &amp;HFF)</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;CalcolaCRC = Temp Xor lngTabellaCRC(IndiceTabellaCRC)</li>
        <li>&nbsp;&nbsp;Next Conta</li>
      </ol>
      <p>Innanzitutto prima di procedere con l'elaborazione del CRC32 &egrave; 
        fondamentale che la tabella <b>lngTabellaCRC</b> sia elaborata. Se il 
        valore della variabile blnTabellaCalcolata &egrave; False la funzione 
        di inizializzazione della tabella non &egrave; stata richiamata in elaborazioni 
        precedenti e pertanto l'operazione dovr&agrave; essere svolta ora, prima 
        di procedere con il codice. Nel caso che la tabella fosse gi&agrave; stata 
        elaborata in precedenza sarebbe superfluo ed impegnativo elaborarla nuovamente.</p>
      <p>Il valore iniziale del CRC &egrave; dato dal parametro <b>CRCPrecedente</b> 
        fornito oppure ottenuto per default. Segue un ciclo eseguito per ogni 
        singolo carattere della stringa <b>Buffer</b> (riga 38). Al suo interno 
        vengono eseguite le quattro operazioni descritte in precedenza:</p>
      <ul>
        <li>Viene estratto il codice ASCII del carattere in esame e memorizzato 
          nella variabile <b>Carattere</b> (riga 39);</li>
        <li>L'operazione di RightShift del CRC di 8 bit viene memorizzata nella 
          variabile <b>Temp</b> (riga 40);</li>
        <li>Viene recuperato e memorizzato nella variabile <b>IndiceTabellaCRC</b> 
          l'indice della matrice effettuando il mix del valore di Carattere con 
          la parte bassa (gli ultimi 8 bit) del CRC precedente (riga 41);</li>
        <li>Il nuovo valore di CRC viene generato mischiando il valore indicato 
          dalla variabile <b>Temp</b> con il valore contenuto nella tabella alla 
          posizione indicata da <b>IndiceTabellaCRC</b> (riga 42).</li>
      </ul>
      <p>Tale passaggio &egrave; ripetuto per ogni carattere della stringa di 
        cui calcolare il CRC32.</p>
      <ol class="codicevb" start="44">
        <li>&nbsp;&nbsp;If UltimoCRC = True Then CalcolaCRC = Not CalcolaCRC</li>
        <li>End Function</li>
      </ol>
      <p>Prima di concludere la funzione viene effettuato un ultimo controllo: 
        se il valore del parametro <b>UltimoCRC</b> &egrave; <i><b>True</b></i> 
        sar&agrave; necessario effettuare un'ultimo aggiustamento al valore del 
        CRC32 invertendone tutti i bit (riga 44).<br>
        L'operazione &egrave; necessaria SOLTANTO per l'ultimo pezzo di CRC da 
        calcolare. </p>
      <hr>
    <p align="center"><script type="text/javascript"><!--
google_ad_client = "pub-8218922773694577";
/* Contenuti 468x60 */
google_ad_slot = "0785185013";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></p>
      <p align="center" class="size3">Come applicare il CRC32</p>
      <p>Vediamo un semplice utilizzo del modulo appena sviluppato effettuando 
        il calcolo del codice CRC32 di un file di testo a scelta dell'utente. 
        &Egrave; importante considerare che il file scelto dall'utente pu&ograve; 
        essere di qualunque dimensione: &egrave; pertanto errato provare a caricarlo 
        interamente in memoria e calcolare il CRC32 in un'unica operazione. Il 
        file pertanto sar&agrave; letto a blocchi di 2 KB per volta ed ogni volta 
        sar&agrave; calcolato il CRC32 di ogni blocco. La funzione <i>CalcolaCRC</i> 
        infatti permette un calcolo segmentato, mediante l'utilizzo del parametro 
        <b>CRCPrecedente</b>.</p>
      <p><img src="../images/activity/att18_01.png" width="331" height="47" align="right" alt="Figura 1">Il 
        nostro form si comporr&agrave; di tre soli e semplici controlli: una Label 
        descrittiva di nome <b>lblNomeFile</b>, una TextBox in cui l'utente immetter&agrave; 
        il percorso del file di cui calcolare il CRC32, di nome <b>txtNomeFile</b> 
        ed un semplice pulsante di nome <b>cmdCalcolaCRC32</b>.<br>
        Il codice si compone di un'unica routine:</p>
      <ol class="codicevb" start="1">
        <li>Private Sub btnCalcolaCRC32_Click()</li>
        <li>&nbsp;&nbsp;Dim FileNR As Integer</li>
        <li>&nbsp;&nbsp;Dim Buffer As String</li>
        <li>&nbsp;&nbsp;Dim CRC32 As Long</li>
        <li>&nbsp;&nbsp;txtNomeFile.Text = Trim$(txtNomeFile.Text)</li>
        <li>&nbsp;&nbsp;If (Dir(txtNomeFile.Text, vbNormal) = &quot;&quot;) Or 
          (txtNomeFile.Text = &quot;&quot;) Then</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;MsgBox &quot;Il file specificato non esiste!&quot;, 
          vbCritical Or vbOKOnly</li>
        <li>&nbsp;&nbsp;Else</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;If (GetAttr(txtNomeFile.Text) And vbDirectory) 
          &lt;&gt; vbDirectory Then</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Me.MousePointer = vbHourglass</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FileNR = FreeFile</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Open txtNomeFile.Text For Binary 
          Access Read As FileNR</li>
      </ol>
      <p>Alla riga 6 viene verificata l'esistenza del file specificato nella casella 
        <b>txtNomeFile</b>; vedi anche l'<a href="../howto/ht_011.htm">HowTo dedicato 
        alla verifica dell'esistenza di un file</a> ed alla riga 9 viene appurato 
        che non si tratti di una cartella.</p>
      <p>Con la certezza che il file esiste, alla riga 12 viene effettuata l'apertura 
        in modalit&agrave; binaria dello stesso. Vedi anche l'<a href="../howto/ht_003.htm">HowTo 
        dedicato alla lettura del contenuto di un file</a>.</p>
      <ol class="codicevb" start="13">
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CRC32 = CalcolaCRC(&quot;&quot;)</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Buffer = String$(2048, 0)</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Do</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Get FileNR, , Buffer</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If EOF(FileNR) Then 
          Buffer = Left$(Buffer, 2048 - Loc(FileNR) + LOF(FileNR))</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CRC32 = CalcolaCRC(Buffer, 
          CRC32, False)</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Loop Until EOF(FileNR)</li>
      </ol>
      <p>La prima operazione da effettuare &egrave; l'inizializzazione del valore 
        di CRC32, effettuata passando semplicemente alla funzione <i>CalcolaCRC</i> 
        una stringa vuota (riga 13). Come specificato in precedenza, il contenuto 
        del file verr&agrave; letto a blocchi di 2&nbsp;KB ciascuno; a tale scopo, 
        alla riga 14 viene preparata la variabile <b>Buffer</b>.</p>
      <p>Segue un ciclo che si ripeter&agrave; fino a quando non verr&agrave; 
        letto tutto il file, sempre a blocchi di 2&nbsp;KB ciascuno. L'unico controllo 
        necessario riguarda la fine del file (riga 17).<br>
        L'ultimo blocco del file infatti non sar&agrave; grande 2&nbsp;KB esatti 
        ma la sua dimensione risulter&agrave; dal resto delle letture precedenti. 
        Ad esempio durante la lettura di un file di 5&nbsp;KB i primi due blocchi 
        avranno dimensione normale 2&nbsp;KB ma l'ultimo far&agrave; eccezione 
        con 1&nbsp;KB. Viene pertanto verificato se ci troviamo alla fine del 
        file ed in tal caso il buffer viene ridimensionato.</p>
      <p>Ogni pacchetto del file letto viene inviato alla funzione <i>CalcolaCRC</i>, 
        fornendo anche il valore del CRC precedente. Il terzo parametro indicher&agrave; 
        che il pacchetto inviato non &egrave; l'ultimo ma si richiedono ulteriori 
        elaborazioni. Il valore di ritorno della funzione <i>CalcolaCRC</i> viene 
        memorizzato nella variabile <b>CRC32</b> per riutilizzarlo nell'elaborazione 
        del blocco successivo. Infatti <b>CRC32</b> &egrave; sia valore di ritorno 
        che parametro inviato alla funzione.</p>
      <ol class="codicevb" start="20">
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Close FileNR</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CRC32 = CalcolaCRC(&quot;&quot;, 
          CRC32, True)</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MsgBox &quot;Il CRC32 del file 
          &egrave; &quot; &amp; Hex(CRC32), vbInformation Or vbOKOnly</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Me.MousePointer = vbDefault</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;End If</li>
        <li>&nbsp;&nbsp;End If</li>
        <li>End Sub</li>
      </ol>
      <p>Alla fine del ciclo di lettura ed elaborazione del CRC32 viene chiuso 
        il file (riga 20) ed infine effettuata l'<b>ultima elaborazione</b> per 
        richiedere il valore finale del CRC passato come parametro (riga 21).<br>
        Ottenuto l'ultimo dato esso sar&agrave; mostrato tramite una MessageBox 
        (riga 22).</p>
      <hr>
      <p align="center" class="size3">Ulteriori applicazioni del CRC32</p>
      <p>Si consideri sempre il CRC32 come un metodo di verifica dei dati e mai 
        come sistema di protezione contro le modifiche dei dati. L'algoritmo infatti 
        &egrave; standard nell'elaborazione; quello che pu&ograve; cambiare &egrave; 
        il suo campo di applicazione oppure il valore di seme utilizzato.</p>
      <p>Possiamo infatti memorizzare nei nostri programmi (e dove lo vedremo 
        subito dopo) il CRC32 di ogni singolo file, oppure valore di singoli segmenti 
        del file in analisi. Quello che si rivela utile controllare sono i dati 
        critici alla corretta elaborazione di un processo.</p>
      <p>Potrebbe essere utile verificare ad esempio che un certo blocco di dati 
        non sia stato modificato poich&eacute; in tal caso il programma fornirebbe 
        dati importanti ma fondamentalmente errati, ad esempio in un file di dati 
        di un bilancio aziendale.</p>
      <p>Resta da sciogliere un ultimo punto: dove e come memorizzare i valori 
        di CRC32 senza che questi vadano a modificare il contenuto del file la 
        cui elaborazione produrrebbe un CRC32 differente?</p>
      <p>Le soluzioni pi&ugrave; semplici consistono in un file di dati di appoggio. 
        Tutti i CRC32 possono essere scritti al suo interno ed il programma che 
        ne richiede la verifica si occuper&agrave; di estrarli e confrontali con 
        il valore CRC32 reale ottenuto dall'elaborazione.</p>
      <p>Un'altra soluzione potrebbe essere quella di scriverli come <a href="../glossary/f.htm#FILEDIRISORSE">file 
        di risorse</a> <img src="../images/ide/risorse.gif" width="16" height="16" align="absmiddle"> 
        all'interno di un file di <a href="../glossary/l.htm#LIBRERIA">libreria</a> 
        (<a href="../glossary/d.htm#DLL">DLL</a>). Un'ultima soluzione, un po' 
        drastica a dire il vero, consiste nell'aggiungere i dati alla fine del 
        file eseguibile stesso, avendo cura che l'elaborazione del CRC32 di questo 
        escluda quei 4 bytes contenenti il CRC32 stesso.</p>
      <p>In ragione della struttura dell'implementazione adottata l'algoritmo 
        di calcolo potr&agrave; essere utilizzato per calcolare il valore CRC32 
        non solo dell'intero file, ma anche per elaborazioni parziali di dati 
        al fine di velocizzare l'esecuzione di calcolo.<br>
        <br>
      </p>
      <!-- #EndEditable --></td>
  </tr>
</table>

<table width="100%">
  <tr> 
    <td><!-- #BeginEditable "FINALE" --> 
      <p>Qualunque sia la soluzione applicata &egrave; fondamentale tenere a mente 
        che il CRC32 non pu&ograve; essere considerato un algoritmo di protezione. 
        Se qualcuno vuole utilizzarlo come tale abbia almeno la minima cura di 
        criptare i dati rappresentativi del valore di CRC.</p>
      <p>Si tenga anche conto che il presente codice &egrave; sviluppato in puro 
        Visual Basic e come tale &egrave; soggetto ad una pesante lentezza, in 
        parte legata alla soluzione del codice ed in parte legata ai limiti del 
        linguaggio stesso.</p>
      <!-- #EndEditable --><!-- #BeginEditable "CREDITS" --> 
      <p align="right" class="credits2"><a href="../vbmail.htm?id=1">Fibia 
        FBI</a><br>
        26 Gennaio 2002<br>
        Un ringraziamento particolare a <a href="../vbmail.htm?id=12">Detonate</a></p>
      <!-- #EndEditable --><!-- #BeginLibraryItem "/Library/Toolbar.lbi" -->
      <table width="80%" border="1" cellspacing="1" cellpadding="3" align="center" bordercolor="#000000" class="dontprint">
        <tr> 
          <td align="center" valign="top" width="33%"><a href="javascript:ScaricaZIP();"><img src="../images/icons/tool%20download.gif" width="16" height="18" border="0" alt="Scarica il progetto"><br>
            <span class="size1">Scarica il progetto</span></a></td>
          <td align="center" valign="top" width="33%"><a href="javascript:ScaricaPDF();"><img src="../images/icons/tool%20pdf.gif" width="16" height="18" alt="Scarica il testo dell'articolo" border="0"><br>
            <span class="size1">Scarica il testo dell'articolo</span></a></td>
          <td align="center" valign="top" width="33%"><a href="javascript:Stampa();"><img src="../images/icons/tool%20print.gif" width="16" height="18" alt="Stampa l'articolo" border="0"><br>
            <span class="size1">Stampa l'articolo</span></a></td>
        </tr>
      </table><!-- #EndLibraryItem -->
    </td>
  </tr>
</table>
<table width="100%" border="0" cellspacing="2" cellpadding="2">
  <tr>
    <td align="left"><a href="index.htm"><img src="../images/vbprev.jpg" width="49" height="32" align="absmiddle" border="0"> 
      Torna all'introduzione delle Richieste dei lettori</a></td>
    <td align="right">&nbsp;</td>
  </tr>
</table>

<hr width="80%">
<table width="100%">
  <tr>
    <td width="100%" align="center">
      <script language="Javascript">Banner();</script>
      <!--#echo banner=""-->
    </td>
  </tr>
</table>
<script language="Javascript">FibiaWebStats();</script>
</body>
<!-- #EndTemplate --></html>
