<html><!-- #BeginTemplate "/Templates/Weird.dwt" -->
<head>
<script language="JavaScript" src="../funzioni.js"></script>
<script language="JavaScript" src="../scroller.js"></script>
<!-- #BeginEditable "doctitle" --> 
<title>Si, no, forse...</title>
<!-- #EndEditable --> 
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link href="../stili.css" rel="stylesheet" type="text/css" title="stili">
<link href="../codicevb.css" rel="stylesheet" type="text/css" title="codicevb">
<link href="../colori.css" rel="stylesheet" type="text/css" title="colori">
<meta name="description" content="Visual Basic Simple &egrave; l'unico sito in Italia che tratta la programmazione in Visual Basic in un'ottica mai vista prima d'ora. Tutti gli articoli sono spiegati passo dopo passo ed in una maniera davvero semplice per consentire a tutti di comprendere gli argomenti trattati.">
<meta name="keywords" content="VB, Visual, Basic, Simple, programmazione, codici, esempi, manuali, studio, sviluppo, ActiveX, OCX, articoli, notizie, apprendere, QBasic, API, COM, database">
</head>

<body bgcolor="#FFFFFF" leftmargin="0" topmargin="0">
<table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#FFFFFF">
  <tr>
    <td width="400" align="left" bgcolor="#FFFFFF"><img src="../images/vbslogo.jpg" width="400" height="80" border="0" alt="Visual Basic Simple"></td>
    <td width="100%" align="right" bgcolor="#FFFFFF"> 
      <div class="intestazioni"><a href="../home.htm">Home Page</a> <a href="../home.htm"><img src="../images/icons/dothome.gif" align="absmiddle" border="0" alt="Home Page" width="25" height="25"></a><br>
        <a href="../history.htm">Novit&agrave;</a> <a href="../history.htm"><img src="../images/icons/dotinfo.gif" align="absmiddle" border="0" alt="Informazioni su VB Simple" width="25" height="25"></a><br>
        <a href="../help.htm">Aiuto</a> <a href="../help.htm"><img src="../images/icons/dothelp.gif" align="absmiddle" border="0" alt="Hai bisogno d'aiuto?" width="25" height="25"></a></div>
    </td>
    <td width="160" align="center"><script type="text/javascript"><!--
google_ad_client = "pub-8218922773694577";
/* 160x90, creato 02/02/09 */
google_ad_slot = "8970907891";
google_ad_width = 160;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></td>
  </tr>
</table>

<div align="center"> 
  <div class="titolo"><!-- #BeginEditable "TITOLO" -->Si, no, forse...<!-- #EndEditable --> 
    <!-- #BeginEditable "API" --><img src="../images/api.gif" width="34" height="24" align="absmiddle"><!-- #EndEditable --></div>
  <script language="Javascript">NomePagina();</script>
  <table width="80%" border="1" cellspacing="1" cellpadding="3" bordercolorlight="#000000" bordercolordark="#000000" class="dontprint">
    <tr class="size0"> 
      <td align="center" width="25%"><a href="../ftv21/weird.htm" target="treeframe"><img src="../images/icons/search%20window.gif" width="16" height="16" border="0" alt="Sincronizza Indice"><br>
        Sincronizza Indice</a></td>
      <td align="center" width="25%"><a href="javascript:ScaricaZIP();"><img src="../images/icons/tool%20download.gif" width="16" height="18" border="0" alt="Scarica il progetto"><br>
        Scarica il progetto</a></td>
      <td align="center" width="25%"><a href="javascript:ScaricaPDF();"><img src="../images/icons/tool%20pdf.gif" width="16" height="18" alt="Scarica il testo dell'articolo" border="0"><br>
        Testo dell'articolo</a></td>
      <td align="center" width="25%"><a href="javascript:Stampa();"><img src="../images/icons/tool%20print.gif" width="16" height="18" alt="Stampa l'articolo" border="0"><br>
        Stampa l'articolo</a></td>
    </tr>
  </table>
</div>
<table width="100%" border="0">
  <tr> 
    <td width="80%"> 
      <p align="right" class="size3">Difficolt&agrave;: <img src="../images/icons/level1.gif" width="17" height="18" align="absmiddle"><!-- #BeginEditable "DIFFICOLTA" --><img src="../images/icons/level2.gif" width="17" height="18" align="absmiddle"><img src="../images/icons/level3.gif" width="17" height="18" align="absmiddle"> 
        3<!-- #EndEditable --> / 5</p>
      <script language="JavaScript">ShowArticlesScroller();</script><!-- #BeginEditable "CORPO" --> 
      <p>Nel corso base abbiamo <a href="../base/bas_08.htm">introdotto la logica 
        booleana</a>, secondo la quale tutte le espressioni ricevono un risultato 
        Vero o Falso ed abbiamo potuto approfondire l'<a href="../info/info_06.htm">algebra 
        booleana nelle informazioni aggiuntive</a>. &Egrave; noto quindi a tutti 
        che se un'espressione restituisce valore Vero, combinando tale espressione 
        con l'operatore <b>NOT</b> otteniamo il valore Falso.</p>
      <p>Tutto vero se non esistessero le leggi di Murphy a capovolgere tutte 
        le regole esistenti e conosciute nell'universo. <img src="../images/icons/smile%20wink.gif" width="15" height="15" align="absmiddle"></p>
      <p align="center"><script type="text/javascript"><!--
google_ad_client = "pub-8218922773694577";
/* 468x60 solo grafica */
google_ad_slot = "0981518759";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></p>
      <p>L'esempio trattato utilizza la funzione <a href="../glossary/a.htm#API">API</a> 
        <b>SHFileOperation</b> che necessita a sua volta di una struttura di nome 
        <i><b>SHFILEOPSTRUCT</b></i>.</p>
      <p>La definizione di tale struttura &egrave; stata, purtroppo, molte volte 
        errata anche da parte di Microsoft. La documentazione ufficiale MSDN infatti 
        dichiara la struttura <img src="../images/ide/tipoudt.gif" width="16" height="16" align="absmiddle"> 
        con:</p>
      <ol start="1" class="codicevb">
        <li>typedef struct _SHFILEOPSTRUCT{</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;HWND hwnd;</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;UINT wFunc;</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR pFrom;</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR pTo;</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;FILEOP_FLAGS fFlags;</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;BOOL fAnyOperationsAborted;</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID hNameMappings;</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR lpszProgressTitle;</li>
        <li>} SHFILEOPSTRUCT, FAR *LPSHFILEOPSTRUCT;</li>
      </ol>
      <p>E la trasporta quindi in Visual Basic come:</p>
      <ol start="1" class="codicevb">
        <li>Private Type SHFILEOPSTRUCT</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;hwnd As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;wFunc As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;pFrom As String</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;pTo As String</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;fFlags As Integer</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;fAnyOperationsAborted As Boolean</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;hNameMappings As Long</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;lpszProgressTitle As String</li>
        <li>End Type</li>
      </ol>
      <p>[ <a href="http://support.microsoft.com/default.aspx?scid=kb;EN-US;Q154005">Tratto 
        da How To Delete a File into the Win95 Recycle Bin (Q154005)</a> ]</p>
      <p>Si tratta effettivamente di una svista di qualche sbadato programmatore, 
        che &egrave; stata corretta successivamente con una postilla come questa, 
        aggiunta in altri articoli sullo stesso argomento: <i>&quot;NOTE: The 
        32-bit version of Visual Basic aligns structures at double word boundaries, 
        but some API functions, such as the SHFileOperation, expect the data to 
        arrive as byte aligned&quot;</i>.</p>
      <p>Tuttavia lo stesso errore &egrave; stato commesso da tantissimi altri 
        programmatori che sottovalutavano il comportamento di Visual Basic nell'uso 
        di tipi di dati definiti dall'utente, cosicch&eacute; la precedente definizione 
        di <b>SHFILEOPSTRUCT</b> si &egrave; diffusa notevolmente facendo passare 
        l'errore inosservato.</p>
      <hr>
    <p align="center"><script type="text/javascript"><!--
google_ad_client = "pub-8218922773694577";
/* Contenuti 468x60 */
google_ad_slot = "0785185013";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></p>
      <p>Svilupperemo un semplicissimo progetto per dimostrare come un errore 
        di questo genere pu&ograve; facilmente condurre a dubitare sulla correttezza 
        delle regole di base dell'algebra booleana.</p>
      <ol start="1" class="codicevb">
        <li>Option Explicit</li>
        <li></li>
        <li>Private Type SHFILEOPSTRUCT</li>
        <li>&nbsp;&nbsp;hWnd As Long</li>
        <li>&nbsp;&nbsp;wFunc As Long</li>
        <li>&nbsp;&nbsp;pFrom As String</li>
        <li>&nbsp;&nbsp;pTo As String</li>
        <li>&nbsp;&nbsp;fFlags As Integer</li>
        <li>&nbsp;&nbsp;fAnyOperationsAborted As Boolean</li>
        <li>&nbsp;&nbsp;hNameMaps As Long</li>
        <li>&nbsp;&nbsp;sProgress As String</li>
        <li>End Type</li>
        <li></li>
        <li>Private Const FO_DELETE = &amp;H3</li>
        <li></li>
        <li>Private Declare Function SHFileOperation Lib "shell32.dll" Alias "SHFileOperationA" 
          (lpFileOp As SHFILEOPSTRUCT) As Long</li>
        <li></li>
      </ol>
      <p>Le dichiarazioni riprendono la definizione precedente di <i><b>SHFILEOPSTRUCT</b></i> 
        e vi aggiungono la dichiarazione della funzione API <i>SHFileOperation</i> 
        che utilizza tale struttura.</p>
      <ol start="18" class="codicevb">
        <li>Private Sub Form_Load()</li>
        <li>&nbsp;&nbsp;Dim udtFileOp As SHFILEOPSTRUCT</li>
        <li>&nbsp;&nbsp;Open "c:\blabla.txt" For Output As #1</li>
        <li>&nbsp;&nbsp;Write #1, "ciao ciao"</li>
        <li>&nbsp;&nbsp;Close #1</li>
      </ol>
      <p>All'avvio del programma sar&agrave; creato un file di testo di nome BLABLA.TXT 
        e posto nella radice del disco C:. Questo non &egrave; il modo migliore 
        di scrivere un file di testo ma &egrave; stata utilizzata la soluzione 
        pi&ugrave; semplice possibile. A tale scopo si consulti l'<a href="../howto/ht_026.htm">articolo 
        riguardante la scrittura di un file di testo</a>.</p>
      <ol start="23" class="codicevb">
        <li> &nbsp;&nbsp;With udtFileOp</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;.hWnd = Me.hWnd</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;.pFrom = "c:\blabla.txt"</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;.wFunc = FO_DELETE</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;Call SHFileOperation(udtFileOp)</li>
      </ol>
      <p>Alla riga 27 &egrave; richiamata la funzione <i>SHFileOperation</i> con 
        la variabile <b>udtFileOp</b> che conterr&agrave; il percorso del file 
        da eliminare (riga 25) e l'operazione richiesta &egrave; la cancellazione 
        (riga 26).</p>
      <p><img src="../images/weird/weird06_01.png" width="335" height="99" align="right" alt="Figura 1">Quando 
        viene richiesto di eliminare il file &egrave; fondamentale rispondere 
        <i> <b>No</b></i>.</p>
      <p>La funzione al suo ritorno dovrebbe pertanto indicare che l'utente ha 
        annullato l'operazione ed &egrave; questo lo scopo del <a href="../glossary/m.htm#MEMBRO">membro</a> 
        <b>fAnyOperationsAborted</b> della struttura e qui appare la stranezza.</p>
      <ol start="28" class="codicevb">
        <li> &nbsp;&nbsp;&nbsp;&nbsp;MsgBox ".fAnyOperationsAborted=" &amp; .fAnyOperationsAborted</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;MsgBox "Not .fAnyOperationsAborted=" &amp; 
          (Not .fAnyOperationsAborted)</li>
      </ol>
      <p>Le due righe 28 e 29 dovrebbero dati risultati opposti. Mentre la prima, 
        come detto restituisce valore Vero, la seconda dovrebbe riportare il risultato 
        Falso, in ragione dell'operatore <b>Not</b> usato.</p>
      <table width="80%" border="0" cellspacing="0" cellpadding="0" align="center">
        <tr> 
          <td width="50%" align="center" valign="top"><img src="../images/weird/weird06_02.png" width="134" height="80" alt="Figura 2"><br>
            <b>Figura 2</b></td>
          <td width="50%" align="center" valign="top"><img src="../images/weird/weird06_03.png" width="150" height="80" alt="Figura 3"><br>
            <b>Figura 3</b></td>
        </tr>
      </table>
      <p>Purtroppo, come mostrano le due figure sovrastanti, in entrambi i casi 
        il risulato &egrave; Vero. Sembra assurdo a dirsi ma il contrario di Vero 
        &egrave; Vero.</p>
      <p>Esiste una spiegazione di questo comportamento a dir poco assurdo ed 
        &egrave; legato all'errata dichiarazione della struttura <i><b>SHFILEOPSTRUCT</b></i>.</p>
      <ol start="30" class="codicevb">
        <li> &nbsp;&nbsp;&nbsp;&nbsp;MsgBox &quot;Eccone la ragione: &quot; &amp; 
          vbNewLine &amp; ".fAnyOperationsAborted=" &amp; CLng(.fAnyOperationsAborted) 
          &amp; &quot; (&quot; &amp; CBool(.fAnyOperationsAborted) &amp; ")" &amp; 
          vbNewLine &amp; "Not .fAnyOperationsAborted=" &amp; CLng(Not .fAnyOperationsAborted) 
          &amp; &quot; (&quot; &amp; CBool(Not .fAnyOperationsAborted) &amp; ")"</li>
        <li>&nbsp;&nbsp;End With</li>
        <li>&nbsp;&nbsp;Unload Me</li>
        <li>End Sub</li>
      </ol>
      <p align="center"><script type="text/javascript"><!--
google_ad_client = "pub-8218922773694577";
/* 468x60 solo testo */
google_ad_slot = "6726967947";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script></p>
      <p><img src="../images/weird/weird06_04.png" width="165" height="101" align="right">L'aver 
        dichiarato il membro come Boolean limita le risposte a Vero e Falso che 
        la variabile restituisce. Tuttavia l'operatore <b>Not</b> non valuta l'espressione 
        prima di invertirla ma il linguaggio segue un percorso differente.</p>
      <p>L'operatore <b>Not</b> in realt&agrave; inverte tutti i bit della variabile 
        in questione (<i>.fAnyOperationsAborted</i>) ed il risultato &egrave; 
        riportato come espressione da valutare.<br>
        Una variabile booleana contiene il valore Falso quando tutti i bit che 
        la compongono sono 0 e contiene valore Vero quando almeno uno dei suoi 
        bit sia 1. Solitamente una variabile booleana contiene il valore <b>0</b> 
        (0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;=&nbsp;Falso) e la negazione 
        produce quindi il risultato <b>-1</b> (1111&nbsp;1111&nbsp;1111&nbsp;1111&nbsp;=&nbsp;Vero).</p>
      <p>Tuttavia, come abbiamo gi&agrave; detto, e come nel nostro caso, se la 
        variabile non contiene il valore 0, il risultato booleano sar&agrave; 
        comunque Vero. Nell'esempio precedente infatti la variabile <i>.fAnyOperationsAborted</i> 
        assume valore 1 se l'utente ha annullato l'operazione; pertanto la negazione 
        (l'inversione dei bit) del valore <b>1</b> (0000&nbsp;0001) produce il 
        valore <b>-2</b> (1111&nbsp;1110), la cui valutazione booleana corrisponde 
        sempre a Vero. L'unico caso in cui il risultato &egrave; Falso avviene 
        quando <b>tutti i bit</b> della variabile sono uguali a 0 e l'inversione 
        produce il risultato contrario.</p>
      <p><img src="../images/notes2.gif" width="31" height="32" align="left">Dopo 
        aver terminato l'uso dell'esempio mostrato in precedenza, ricordarsi di 
        eliminare manualmente oppure mediante il programma stesso il file <b>C:\BLABLA.TXT</b>.<br>
        <br>
      </p>
      <!-- #EndEditable --></td>
  </tr>
</table>

<table width="100%">
  <tr> 
    <td><!-- #BeginEditable "FINALE" --> 
      <p>Questo esempio voleva dimostrare come un semplice errore nella dichiarazione 
        pu&ograve; generare una serie di errore difficili da tracciare perch&eacute; 
        sintatticamente tutto appare corretto.</p>
      <p>Per concludere, la dichiarazione corretta della struttura <i><b>SHFILEOPSTRUCT</b></i> 
        utilizza dei valori Long sia per il membro <i>fFlags</i> sia per il successivo 
        <i>fAnyOperationsAborted</i>. Si raccomanda quindi di non fidarsi ciecamente 
        delle dichiarazioni API copiate da qualche esempio ma, in caso di errori 
        insoliti, verificare il valore di ciascun membro delle strutture API.</p>
      <!-- #EndEditable -->
      <p align="right" class="credits2"><!-- #BeginEditable "CREDITS" --><a href="../vbmail.htm?id=1">Fibia 
        FBI</a><br>
        27 Dicembre 2002<!-- #EndEditable --></p>
      <!-- #BeginLibraryItem "/Library/Toolbar.lbi" -->
      <table width="80%" border="1" cellspacing="1" cellpadding="3" align="center" bordercolor="#000000" class="dontprint">
        <tr> 
          <td align="center" valign="top" width="33%"><a href="javascript:ScaricaZIP();"><img src="../images/icons/tool%20download.gif" width="16" height="18" border="0" alt="Scarica il progetto"><br>
            <span class="size1">Scarica il progetto</span></a></td>
          <td align="center" valign="top" width="33%"><a href="javascript:ScaricaPDF();"><img src="../images/icons/tool%20pdf.gif" width="16" height="18" alt="Scarica il testo dell'articolo" border="0"><br>
            <span class="size1">Scarica il testo dell'articolo</span></a></td>
          <td align="center" valign="top" width="33%"><a href="javascript:Stampa();"><img src="../images/icons/tool%20print.gif" width="16" height="18" alt="Stampa l'articolo" border="0"><br>
            <span class="size1">Stampa l'articolo</span></a></td>
        </tr>
      </table><!-- #EndLibraryItem -->
    </td>
  </tr>
</table>
<table width="100%" border="0" cellspacing="2" cellpadding="2">
  <tr>
    <td align="left"><a href="index.htm"><img src="../images/vbprev.jpg" width="49" height="32" align="absmiddle" border="0"> 
      Torna all'indice delle Stranezze</a></td>
    <td align="right">&nbsp;</td>
  </tr>
</table>

<hr width="80%">
<table width="100%">
  <tr>
    <td width="100%" align="center">
      <script language="Javascript">Banner();</script>
      <!--#echo banner=""-->
    </td>
  </tr>
</table>
<script language="Javascript">FibiaWebStats();</script>
</body>
<!-- #EndTemplate --></html>
